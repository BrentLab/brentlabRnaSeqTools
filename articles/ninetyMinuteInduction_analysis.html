<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="brentlabRnaSeqTools">
<title>90 Minute Induction Analysis Data Creation • brentlabRnaSeqTools</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="90 Minute Induction Analysis Data Creation">
<meta property="og:description" content="brentlabRnaSeqTools">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">brentlabRnaSeqTools</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/ProccessRun.html">Process a New Run From MGI</a>
    <a class="dropdown-item" href="../articles/QC_Library_Quality.html">QC: Library Quality</a>
    <a class="dropdown-item" href="../articles/QC_Sample_Agreement_Analysis_Tally.html">QC: Replicate Agreement Analysis and tally</a>
    <a class="dropdown-item" href="../articles/QC_Sample_Agreement_Objects.html">QC: Replicate Agreement Object Creation</a>
    <a class="dropdown-item" href="../articles/UsingRstudioProjects.html">UsingRstudioProjects</a>
    <a class="dropdown-item" href="../articles/envPerturbation.html">Environmental Perturbation Analysis Data Creation</a>
    <a class="dropdown-item" href="../articles/ninetyMinInduction_tally.html">90 Minute Induction Tally</a>
    <a class="dropdown-item" href="../articles/ninetyMinuteInduction_analysis.html">90 Minute Induction Analysis Data Creation</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="ninetyMinuteInduction_analysis_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>90 Minute Induction Analysis Data Creation</h1>
                        <h4 data-toc-skip class="author">Chase Mateusiak</h4>
            
            <h4 data-toc-skip class="date">02/01/2022</h4>
      
      
      <div class="d-none name"><code>ninetyMinuteInduction_analysis.Rmd</code></div>
    </div>

    
        <div class="abstract">
      <p class="abstract">Abstract</p>
      <p>Create a data object ready for analysis for the 90 Minute Induction experiment set. brentlabRnaSeqTools package version: 0.0.0.0</p>
    </div>
    
<div class="section level2">
<h2 id="brentlabrnaseqset">BrentlabRnaSeqSet<a class="anchor" aria-label="anchor" href="#brentlabrnaseqset"></a>
</h2>
<p>The <code>BrentlabRnaSeqSet</code> is a child of the <a href="http://bioconductor.org/packages/devel/bioc/vignettes/DESeq2/inst/doc/DESeq2.html#the-deseqdataset" class="external-link">DESeqDataSet</a>, which is a child of <a href="https://bioconductor.org/packages/release/bioc/vignettes/SummarizedExperiment/inst/doc/SummarizedExperiment.html" class="external-link">SummarizedExperiment</a>.</p>
<p>Therefore, the <code>brentlabRnaSeqSet</code> has all of the DESeq functionality – eg, DESeq size factor normalization, or the <code>DESeq()</code> function – as well as all of the SummarizedExperiment methods, and some more ‘custom’ methods more suited to our purposes. It is easily extensible – for those more computationally minded users, it would be a good idea to learn and use the object oriented programming tools. There are many cases in which doing so will make your code less error prone, easier to test, more reproducible, and easier to maintain long term.</p>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">brentlabRnaSeqTools</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">rtracklayer</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span>

<span class="co"># set variables </span>

<span class="va">KN99_GFF_PATH</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"kn99_gff"</span><span class="op">)</span>
<span class="va">DB_USERNAME</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"db_username"</span><span class="op">)</span>
<span class="va">DB_PASSWORD</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"db_password"</span><span class="op">)</span>

<span class="co"># note: I mount to the cluster and output directly to it</span>
<span class="va">DDS_OUTPUT_DIR</span> <span class="op">=</span> <span class="st">"/mnt/htcf_scratch/chasem/rnaseq_pipeline/experiments/90minDataFreeze"</span>

<span class="co"># controls whether dds objects are written</span>
<span class="va">WRITE_OUT</span> <span class="op">=</span> <span class="cn">FALSE</span>

<span class="co"># Pull the database ----</span>

<span class="va">blrs</span> <span class="op">=</span> <span class="fu"><a href="../reference/brentlabRnaSeqSet.html">brentlabRnaSeqSetFromDatabase</a></span><span class="op">(</span><span class="st">'kn99'</span>,<span class="va">DB_USERNAME</span>, <span class="va">DB_PASSWORD</span><span class="op">)</span>

<span class="co"># filter down to just the protein coding genes. Note that this works because the</span>
<span class="co"># nctr-rna annotations were all added to the end of the annotation file.</span>
<span class="va">blrs</span> <span class="op">=</span> <span class="va">blrs</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6967</span>,<span class="op">]</span>

<span class="co"># Add gene level data (optional) ----</span>

<span class="co"># this adds all of the data regarding each locus as a GRange object to the</span>
<span class="co"># gene data slot of the brentlabRnaSeqSet object. Useful if you are going to</span>
<span class="co"># use other Bioconductor packages.</span>

<span class="va">kn99_gff</span> <span class="op">=</span> <span class="fu">rtracklayer</span><span class="fu">::</span><span class="fu">import</span><span class="op">(</span><span class="va">KN99_GFF_PATH</span><span class="op">)</span>

<span class="va">kn99_genes</span> <span class="op">=</span> <span class="va">kn99_gff</span><span class="op">[</span><span class="va">kn99_gff</span><span class="op">$</span><span class="va">ID</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">blrs</span><span class="op">)</span><span class="op">]</span>

<span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/RangedSummarizedExperiment-class.html" class="external-link">rowRanges</a></span><span class="op">(</span><span class="va">blrs</span><span class="op">)</span> <span class="op">=</span> <span class="va">kn99_genes</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">kn99_genes</span><span class="op">$</span><span class="va">ID</span>,<span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">blrs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>

<span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">blrs</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">rowData</a></span><span class="op">(</span><span class="va">blrs</span><span class="op">)</span><span class="op">$</span><span class="va">ID</span></code></pre></div>
<p>If the experiment set you want is not already created, issue an ‘issue report’, and describe the <strong>EXACT</strong> filter that you want to use to create the set. What goes into your set depends on what you describe as your filter, so spend time with the database to figure out what is there.</p>
</div>
<div class="section level2">
<h2 id="minute-induction">90 minute induction<a class="anchor" aria-label="anchor" href="#minute-induction"></a>
</h2>
<div class="section level3">
<h3 id="grant-set-singles">2016 Grant set, singles<a class="anchor" aria-label="anchor" href="#grant-set-singles"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">blrs_90min</span> <span class="op">=</span> <span class="fu"><a href="../reference/createExperimentSet.html">createExperimentSet</a></span><span class="op">(</span><span class="va">blrs</span>, <span class="st">'ninetyMin_2016Grant'</span><span class="op">)</span>

<span class="co"># Quality Filter ----</span>

<span class="va">blrs_90min_qc_passing</span> <span class="op">=</span> <span class="fu"><a href="../reference/qaFilter.html">qaFilter</a></span><span class="op">(</span><span class="va">blrs_90min</span>, 
                                 rle_iqr_threshold <span class="op">=</span> <span class="fl">.6125</span>, 
                                 iqr_colname <span class="op">=</span> <span class="st">"ninetyMin_iqr"</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="set-perturbed-loci-to-zero">Set perturbed loci to zero<a class="anchor" aria-label="anchor" href="#set-perturbed-loci-to-zero"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">blrs_90min_qc_passing</span> <span class="op">=</span> <span class="fu"><a href="../reference/setPerturbedLociToZero.html">setPerturbedLociToZero</a></span><span class="op">(</span><span class="va">blrs_90min_qc_passing</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="expression-filtering">Expression filtering<a class="anchor" aria-label="anchor" href="#expression-filtering"></a>
</h2>
<p>Filter out low expression genes (and anything else you don’t want in the analysis set). How you do this is up to you, the analyst. <a href="https://www.pnas.org/content/107/21/9546" class="external-link">You might use the method proposed in this paper</a> by, among others, Wolfgang Huber, and implemented in the <a href="https://bioconductor.org/packages/release/bioc/html/genefilter.html" class="external-link">bioconductor package</a> <code>geneFilter</code> (as well as DESeq, by default), or you could filter based on some number of samples having greater than some threshold of expression, which is shown below.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># How this is done is up to you, and obviously affects what genes are left in.</span>
<span class="co"># Below is an example. You need to think about the thresholds and filter method </span>
<span class="co"># that suits your purpose best.</span>

<span class="co"># mid_expression_filter &lt;- rowSums(edgeR::cpm(counts(blrs_90min_qc_passing))&gt;4) &gt;= 4</span>

<span class="va">high_disp_fltr</span> <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">blrs_90min_qc_passing</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">passing_genes_all</span><span class="op">$</span><span class="va">gene_id</span>

<span class="va">blrs_90min_qc_passing</span> <span class="op">=</span> <span class="va">blrs_90min_qc_passing</span><span class="op">[</span><span class="va">high_disp_fltr</span>,<span class="op">]</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="split-the-replicate-groups">Split the replicate groups<a class="anchor" aria-label="anchor" href="#split-the-replicate-groups"></a>
</h2>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># note, qaFilter returns those samples with less than 3 replicates, which have NA</span>
<span class="co"># in the RLE stats. Filter those out, also</span>

<span class="va">blrs_90min_qc_passing</span> <span class="op">=</span>
  <span class="va">blrs_90min_qc_passing</span><span class="op">[</span>,<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">blrs_90min_qc_passing</span><span class="op">)</span><span class="op">$</span><span class="va">ninetyMin_iqr</span><span class="op">)</span><span class="op">]</span>

<span class="va">protocol_tallies</span> <span class="op">=</span> <span class="fu"><a href="../reference/replicateByProtocolTally.html">replicateByProtocolTally</a></span><span class="op">(</span><span class="va">blrs_90min_qc_passing</span><span class="op">)</span>

<span class="co"># protocol_tallies$replicates_with_less_than_four_in_both_old_or_new. All of the</span>
<span class="co"># genotypes should be in the list below</span>

<span class="va">protocol_fltr</span> <span class="op">=</span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">blrs_90min_qc_passing</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">genotype1</span> <span class="op">==</span> <span class="st">"CNAG_00031"</span> <span class="op">&amp;</span> <span class="va">libraryProtocol</span> <span class="op">==</span> <span class="st">"SolexaPrep"</span><span class="op">)</span>,
         <span class="op">!</span><span class="op">(</span><span class="va">genotype1</span> <span class="op">==</span> <span class="st">"CNAG_00871"</span> <span class="op">&amp;</span> <span class="va">libraryProtocol</span> <span class="op">==</span> <span class="st">"E7420L"</span><span class="op">)</span>,
         <span class="op">!</span><span class="op">(</span><span class="va">genotype1</span> <span class="op">==</span> <span class="st">"CNAG_00883"</span> <span class="op">&amp;</span> <span class="va">libraryProtocol</span> <span class="op">==</span> <span class="st">"E7420L"</span><span class="op">)</span>,
         <span class="op">!</span><span class="op">(</span><span class="va">genotype1</span> <span class="op">==</span> <span class="st">"CNAG_01626"</span> <span class="op">&amp;</span> <span class="va">libraryProtocol</span> <span class="op">==</span> <span class="st">"E7420L"</span><span class="op">)</span>,
         <span class="op">!</span><span class="op">(</span><span class="va">genotype1</span> <span class="op">==</span> <span class="st">"CNAG_02774"</span> <span class="op">&amp;</span> <span class="va">libraryProtocol</span> <span class="op">==</span> <span class="st">"E7420L"</span><span class="op">)</span>,
         <span class="op">!</span><span class="op">(</span><span class="va">genotype1</span> <span class="op">==</span> <span class="st">"CNAG_03018"</span> <span class="op">&amp;</span> <span class="va">libraryProtocol</span> <span class="op">==</span> <span class="st">"SolexaPrep"</span><span class="op">)</span>,
         <span class="op">!</span><span class="op">(</span><span class="va">genotype1</span> <span class="op">==</span> <span class="st">"CNAG_03279"</span> <span class="op">&amp;</span> <span class="va">libraryProtocol</span> <span class="op">==</span> <span class="st">"SolexaPrep"</span><span class="op">)</span>,
         <span class="op">!</span><span class="op">(</span><span class="va">genotype1</span> <span class="op">==</span> <span class="st">"CNAG_03849"</span> <span class="op">&amp;</span> <span class="va">libraryProtocol</span> <span class="op">==</span> <span class="st">"E7420L"</span><span class="op">)</span>,
         <span class="op">!</span><span class="op">(</span><span class="va">genotype1</span> <span class="op">==</span> <span class="st">"CNAG_04353"</span> <span class="op">&amp;</span> <span class="va">libraryProtocol</span> <span class="op">==</span> <span class="st">"E7420L"</span><span class="op">)</span>,
         <span class="op">!</span><span class="op">(</span><span class="va">genotype1</span> <span class="op">==</span> <span class="st">"CNAG_05222"</span> <span class="op">&amp;</span> <span class="va">libraryProtocol</span> <span class="op">==</span> <span class="st">"SolexaPrep"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">fastqFileNumber</span><span class="op">)</span>

<span class="va">blrs_90min_qc_passing_protocol_fltr</span> <span class="op">=</span>
  <span class="va">blrs_90min_qc_passing</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">blrs_90min_qc_passing</span><span class="op">)</span><span class="op">$</span><span class="va">fastqFileNumber</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span>
                          <span class="va">protocol_fltr</span><span class="op">]</span>

<span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">blrs_90min_qc_passing_protocol_fltr</span><span class="op">)</span><span class="op">$</span><span class="va">libraryDate</span> <span class="op">=</span>
  <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html" class="external-link">droplevels</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">blrs_90min_qc_passing_protocol_fltr</span><span class="op">)</span><span class="op">$</span><span class="va">libraryDate</span><span class="op">)</span></code></pre></div>
<div class="section level3">
<h3 id="re-examine-tallies-after-separating-the-protocol-groups">Re-examine tallies after separating the protocol groups<a class="anchor" aria-label="anchor" href="#re-examine-tallies-after-separating-the-protocol-groups"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># note that the column names may not reflect what is actually pasesd -- this </span>
<span class="co"># function needs some updating due to hard coding colnames. Columns are in order of the</span>
<span class="co"># tables passed in</span>
<span class="va">protocol_fltr_tally</span> <span class="op">=</span>
  <span class="fu"><a href="../reference/createInductionSetTally.html">createInductionSetTally</a></span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">blrs_90min</span><span class="op">)</span><span class="op">)</span>,
                          <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">blrs_90min_qc_passing</span><span class="op">)</span><span class="op">)</span>,
                          <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">blrs_90min_qc_passing_protocol_fltr</span><span class="op">)</span><span class="op">)</span>,
                          <span class="va">grant_df</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="split">Split<a class="anchor" aria-label="anchor" href="#split"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">blrs_90min_qc_passing_protocol_fltr_split</span> <span class="op">=</span>
  <span class="fu"><a href="../reference/splitProtocolGroups.html">splitProtocolGroups</a></span><span class="op">(</span><span class="va">blrs_90min_qc_passing_protocol_fltr</span><span class="op">)</span>

<span class="co"># libraryprotocol date date have their levels dropped. genotype1 still needs it</span>
<span class="co"># this needs to be handled internally somehow</span>

<span class="va">blrs_90min_qc_passing_protocol_fltr_split</span><span class="op">$</span><span class="va">SolexaPrep</span><span class="op">$</span><span class="va">genotype1</span> <span class="op">=</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html" class="external-link">droplevels</a></span><span class="op">(</span><span class="va">blrs_90min_qc_passing_protocol_fltr_split</span><span class="op">$</span><span class="va">SolexaPrep</span><span class="op">$</span><span class="va">genotype1</span><span class="op">)</span>

<span class="va">blrs_90min_qc_passing_protocol_fltr_split</span><span class="op">$</span><span class="va">E7420L</span><span class="op">$</span><span class="va">genotype1</span> <span class="op">=</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html" class="external-link">droplevels</a></span><span class="op">(</span><span class="va">blrs_90min_qc_passing_protocol_fltr_split</span><span class="op">$</span><span class="va">E7420L</span><span class="op">$</span><span class="va">genotype1</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="examine-replicate-tallies-by-protocol-group">Examine replicate tallies by protocol group<a class="anchor" aria-label="anchor" href="#examine-replicate-tallies-by-protocol-group"></a>
</h2>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># filter out those samples with less than 3 replicates in either libraryDate or</span>
<span class="co"># genotype1</span>

<span class="co"># helper function to create model matricies by protocol</span>
<span class="va">createFullSetModelMatricies</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">full_set_split</span><span class="op">)</span><span class="op">{</span>

  <span class="va">full_set_mm_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    E7420L <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span><span class="va">libraryDate</span><span class="op">+</span><span class="va">genotype1</span>,
                          <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">full_set_split</span><span class="op">$</span><span class="va">E7420L</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    SolexaPrep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span><span class="va">libraryDate</span><span class="op">+</span><span class="va">genotype1</span>,
                              <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">full_set_split</span><span class="op">$</span><span class="va">SolexaPrep</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

  <span class="va">full_set_mm_list</span>
<span class="op">}</span>

<span class="co"># return those replicate sets which have less than 2 replicates</span>
<span class="va">lowReplicateParams</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">model_matrix</span><span class="op">)</span><span class="op">{</span>

  <span class="va">mm_summary_df</span> <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>model_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">model_matrix</span><span class="op">)</span>,
                         replicate_tally<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">model_matrix</span><span class="op">)</span><span class="op">)</span>

  <span class="va">low_rep_parameters</span> <span class="op">=</span> <span class="va">mm_summary_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">replicate_tally</span> <span class="op">&lt;</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">model_params</span><span class="op">)</span>

  <span class="va">low_rep_parameters</span> <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="va">low_rep_parameters</span>, <span class="st">"libraryDate"</span><span class="op">)</span>
  <span class="va">low_rep_parameters</span> <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="va">low_rep_parameters</span>, <span class="st">"genotype1"</span><span class="op">)</span>

  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">low_rep_parameters</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># create model matricies from the blrs_90min_qc_passing_protocol_fltr_split</span>
<span class="va">full_set_mm_list</span> <span class="op">=</span>
  <span class="fu">createFullSetModelMatricies</span><span class="op">(</span><span class="va">blrs_90min_qc_passing_protocol_fltr_split</span><span class="op">)</span>

<span class="co"># find low rep parameters</span>
<span class="va">low_rep_parameters</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">full_set_mm_list</span> ,<span class="va">lowReplicateParams</span><span class="op">)</span>

<span class="co"># all dates, no genotypes</span>
<span class="va">low_rep_parameters</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">low_rep_parameters</span>, <span class="va">as.factor</span><span class="op">)</span>

<span class="co"># create filters for each protocol set</span>
<span class="va">e7420l_fltr</span> <span class="op">=</span>
  <span class="op">!</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">blrs_90min_qc_passing_protocol_fltr_split</span><span class="op">$</span><span class="va">E7420L</span><span class="op">)</span><span class="op">$</span><span class="va">libraryDate</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span>
    <span class="va">low_rep_parameters</span><span class="op">$</span><span class="va">E7420L</span>

<span class="va">solexaprep_fltr</span> <span class="op">=</span>
  <span class="op">!</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">blrs_90min_qc_passing_protocol_fltr_split</span><span class="op">$</span><span class="va">SolexaPrep</span><span class="op">)</span><span class="op">$</span><span class="va">libraryDate</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span>
    <span class="va">low_rep_parameters</span><span class="op">$</span><span class="va">SolexaPrep</span>

<span class="co"># create the full set list</span>
<span class="va">fltr_full_set_90min</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
  E7420L <span class="op">=</span> <span class="va">blrs_90min_qc_passing_protocol_fltr_split</span><span class="op">$</span><span class="va">E7420L</span><span class="op">[</span>, <span class="va">e7420l_fltr</span><span class="op">]</span>,
  SolexaPrep <span class="op">=</span> <span class="va">blrs_90min_qc_passing_protocol_fltr_split</span><span class="op">$</span><span class="va">SolexaPrep</span><span class="op">[</span>, <span class="va">solexaprep_fltr</span><span class="op">]</span>
<span class="op">)</span>

<span class="co"># drop the factor levels which no longer exist from the filtered  libraryDate column</span>
<span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">fltr_full_set_90min</span><span class="op">$</span><span class="va">E7420L</span><span class="op">)</span><span class="op">$</span><span class="va">libraryDate</span> <span class="op">=</span>
  <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html" class="external-link">droplevels</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">fltr_full_set_90min</span><span class="op">$</span><span class="va">E7420L</span><span class="op">)</span><span class="op">$</span><span class="va">libraryDate</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">fltr_full_set_90min</span><span class="op">$</span><span class="va">SolexaPrep</span><span class="op">)</span><span class="op">$</span><span class="va">libraryDate</span> <span class="op">=</span>
  <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html" class="external-link">droplevels</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">fltr_full_set_90min</span><span class="op">$</span><span class="va">SolexaPrep</span><span class="op">)</span><span class="op">$</span><span class="va">libraryDate</span><span class="op">)</span>

<span class="co"># no more low rep sets left</span>
<span class="va">fltr_full_set_mm</span> <span class="op">=</span> <span class="fu">createFullSetModelMatricies</span><span class="op">(</span><span class="va">fltr_full_set_90min</span><span class="op">)</span>

<span class="va">low_rep_parameters_2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fltr_full_set_mm</span>, <span class="va">lowReplicateParams</span><span class="op">)</span></code></pre></div>
<div class="section level3">
<h3 id="recheck-tallies-again">Recheck tallies again<a class="anchor" aria-label="anchor" href="#recheck-tallies-again"></a>
</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">protocol_fltr_tally</span> <span class="op">=</span>
  <span class="fu"><a href="../reference/createInductionSetTally.html">createInductionSetTally</a></span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">blrs_90min</span><span class="op">)</span><span class="op">)</span>,
                          <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">blrs_90min_qc_passing</span><span class="op">)</span><span class="op">)</span>,
                          <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">fltr_full_set_90min</span><span class="op">$</span><span class="va">E7420L</span><span class="op">)</span><span class="op">)</span>,
                                <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">fltr_full_set_90min</span><span class="op">$</span><span class="va">SolexaPrep</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
                          <span class="va">grant_df</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="create-hold-out-set">Create hold out set<a class="anchor" aria-label="anchor" href="#create-hold-out-set"></a>
</h2>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">min_set_size</span> <span class="op">=</span> <span class="fl">1</span>

<span class="va">hold_out_set</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
  SolexaPrep <span class="op">=</span> <span class="fu"><a href="../reference/createTestTrainSet.html">createTestTrainSet</a></span><span class="op">(</span><span class="va">fltr_full_set_90min</span><span class="op">$</span><span class="va">SolexaPrep</span>, <span class="va">min_set_size</span><span class="op">)</span>,
  E7420L <span class="op">=</span> <span class="fu"><a href="../reference/createTestTrainSet.html">createTestTrainSet</a></span><span class="op">(</span><span class="va">fltr_full_set_90min</span><span class="op">$</span><span class="va">E7420L</span>, <span class="va">min_set_size</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="set-the-experiment-designs">Set the experiment designs<a class="anchor" aria-label="anchor" href="#set-the-experiment-designs"></a>
</h2>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">setNinetyMinDesign</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">obj</span><span class="op">)</span><span class="op">{</span>
  <span class="va">obj</span><span class="op">$</span><span class="va">genotype1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">genotype1</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/relevel.html" class="external-link">relevel</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">genotype1</span>, ref <span class="op">=</span> <span class="st">"CNAG_00000"</span><span class="op">)</span>

  <span class="va">obj</span><span class="op">$</span><span class="va">libraryDate</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">libraryDate</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/relevel.html" class="external-link">relevel</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">libraryDate</span>, ref <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">libraryDate</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

  <span class="fu">design</span><span class="op">(</span><span class="va">obj</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="op">~</span><span class="va">libraryDate</span> <span class="op">+</span> <span class="va">genotype1</span><span class="op">)</span>
  
  <span class="va">obj</span>
<span class="op">}</span>

<span class="va">fltr_full_set_90min</span> <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">fltr_full_set_90min</span>, <span class="va">setNinetyMinDesign</span><span class="op">)</span>

<span class="va">hold_out_set</span><span class="op">$</span><span class="va">SolexaPrep</span><span class="op">$</span><span class="va">train</span> <span class="op">=</span> <span class="fu">setNinetyMinDesign</span><span class="op">(</span><span class="va">hold_out_set</span><span class="op">$</span><span class="va">SolexaPrep</span><span class="op">$</span><span class="va">train</span><span class="op">)</span>
<span class="va">hold_out_set</span><span class="op">$</span><span class="va">E7420L</span><span class="op">$</span><span class="va">train</span> <span class="op">=</span> <span class="fu">setNinetyMinDesign</span><span class="op">(</span><span class="va">hold_out_set</span><span class="op">$</span><span class="va">E7420L</span><span class="op">$</span><span class="va">train</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="convert-everything-back-to-deseqdataobjects-for-the-time-being">convert everything back to DESeqDataObjects for the time being<a class="anchor" aria-label="anchor" href="#convert-everything-back-to-deseqdataobjects-for-the-time-being"></a>
</h2>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hold_out_set</span><span class="op">$</span><span class="va">SolexaPrep</span> <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">hold_out_set</span><span class="op">$</span><span class="va">SolexaPrep</span>, <span class="va">coerceToDds</span><span class="op">)</span>
<span class="va">hold_out_set</span><span class="op">$</span><span class="va">E7420L</span> <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">hold_out_set</span><span class="op">$</span><span class="va">E7420L</span>, <span class="va">coerceToDds</span><span class="op">)</span>

<span class="va">fltr_full_set_90min</span> <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">fltr_full_set_90min</span>, <span class="va">coerceToDds</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="combine-protocol-groups">combine protocol groups<a class="anchor" aria-label="anchor" href="#combine-protocol-groups"></a>
</h2>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">refactorDesign</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">dds</span><span class="op">)</span><span class="op">{</span>
  
<span class="va">dds</span><span class="op">$</span><span class="va">libraryProtocol</span> <span class="op">=</span>  
  <span class="va">dds</span><span class="op">$</span><span class="va">libraryProtocol</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html" class="external-link">droplevels</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">dds</span><span class="op">$</span><span class="va">libraryDate</span> <span class="op">=</span>  
  <span class="va">dds</span><span class="op">$</span><span class="va">libraryDate</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html" class="external-link">droplevels</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">dds</span><span class="op">$</span><span class="va">genotype1</span> <span class="op">=</span>  
  <span class="va">dds</span><span class="op">$</span><span class="va">genotype1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html" class="external-link">droplevels</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">mm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span><span class="va">libraryProtocol</span> <span class="op">+</span> <span class="va">libraryDate</span> <span class="op">+</span> <span class="va">genotype1</span>, 
                  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">dds</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">min_date</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">dds</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">libraryProtocol</span> <span class="op">==</span> <span class="st">"E7420L"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">libraryDate</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">mm_redux</span> <span class="op">=</span> <span class="va">mm</span><span class="op">[</span>,<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mm</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"libraryDate"</span>, <span class="va">min_date</span><span class="op">)</span><span class="op">)</span>, drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span>

<span class="fu">design</span><span class="op">(</span><span class="va">dds</span><span class="op">)</span> <span class="op">=</span> <span class="va">mm_redux</span>

<span class="va">dds</span>
<span class="op">}</span>

<span class="va">full_set_90min_both_protocols</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">fltr_full_set_90min</span><span class="op">$</span><span class="va">SolexaPrep</span>,
                                      <span class="va">fltr_full_set_90min</span><span class="op">$</span><span class="va">E7420L</span><span class="op">)</span>

<span class="fu">sizeFactors</span><span class="op">(</span><span class="va">full_set_90min_both_protocols</span><span class="op">)</span> <span class="op">=</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">estimateSizeFactors</span><span class="op">(</span><span class="va">fltr_full_set_90min</span><span class="op">$</span><span class="va">SolexaPrep</span><span class="op">)</span><span class="op">$</span><span class="va">sizeFactor</span>, 
    <span class="fu">estimateSizeFactors</span><span class="op">(</span><span class="va">fltr_full_set_90min</span><span class="op">$</span><span class="va">E7420L</span><span class="op">)</span><span class="op">$</span><span class="va">sizeFactor</span><span class="op">)</span>

<span class="va">full_set_90min_both_protocols</span> <span class="op">=</span> <span class="fu">refactorDesign</span><span class="op">(</span><span class="va">full_set_90min_both_protocols</span><span class="op">)</span>

<span class="va">train_set_90min_both_protocols</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">hold_out_set</span><span class="op">$</span><span class="va">SolexaPrep</span><span class="op">$</span><span class="va">train</span>,
                                       <span class="va">hold_out_set</span><span class="op">$</span><span class="va">E7420L</span><span class="op">$</span><span class="va">train</span><span class="op">)</span>

<span class="fu">sizeFactors</span><span class="op">(</span><span class="va">train_set_90min_both_protocols</span><span class="op">)</span> <span class="op">=</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">estimateSizeFactors</span><span class="op">(</span><span class="va">hold_out_set</span><span class="op">$</span><span class="va">SolexaPrep</span><span class="op">$</span><span class="va">train</span><span class="op">)</span><span class="op">$</span><span class="va">sizeFactor</span>, 
    <span class="fu">estimateSizeFactors</span><span class="op">(</span><span class="va">hold_out_set</span><span class="op">$</span><span class="va">E7420L</span><span class="op">$</span><span class="va">train</span><span class="op">)</span><span class="op">$</span><span class="va">sizeFactor</span><span class="op">)</span>

<span class="va">train_set_90min_both_protocols</span> <span class="op">=</span> <span class="fu">refactorDesign</span><span class="op">(</span><span class="va">train_set_90min_both_protocols</span><span class="op">)</span>

<span class="va">test_data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
  SolexaPrep <span class="op">=</span> <span class="va">hold_out_set</span><span class="op">$</span><span class="va">SolexaPrep</span><span class="op">$</span><span class="va">test</span>,
  E7420L <span class="op">=</span> <span class="va">hold_out_set</span><span class="op">$</span><span class="va">E7420L</span><span class="op">$</span><span class="va">test</span>
<span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="write-out">Write out<a class="anchor" aria-label="anchor" href="#write-out"></a>
</h2>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span><span class="op">(</span><span class="va">WRITE_OUT</span><span class="op">)</span><span class="op">{</span>
  <span class="va">today</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/now.html" class="external-link">today</a></span><span class="op">(</span><span class="op">)</span>,<span class="st">"%Y%m%d"</span><span class="op">)</span>

  <span class="va">output_dir</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">DDS_OUTPUT_DIR</span>, <span class="va">today</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">output_dir</span>, recursive<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>

  <span class="co"># note: this is probably better done with a function and map() as the list gets</span>
  <span class="co">#       longer</span>
  <span class="fu"><a href="https://readr.tidyverse.org/reference/read_rds.html" class="external-link">write_rds</a></span><span class="op">(</span><span class="va">fltr_full_set_90min</span><span class="op">$</span><span class="va">E7420L</span>,
            <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>,<span class="st">"full_set_new_protocol_input.dds"</span><span class="op">)</span><span class="op">)</span>

  <span class="fu"><a href="https://readr.tidyverse.org/reference/read_rds.html" class="external-link">write_rds</a></span><span class="op">(</span><span class="va">fltr_full_set_90min</span><span class="op">$</span><span class="va">SolexaPrep</span>,
            <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="st">"full_set_old_protocol_input.dds"</span><span class="op">)</span><span class="op">)</span>

  <span class="fu"><a href="https://readr.tidyverse.org/reference/read_rds.html" class="external-link">write_rds</a></span><span class="op">(</span><span class="va">test_data</span>,
            <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="st">"test_data.rds"</span><span class="op">)</span><span class="op">)</span>

  <span class="fu"><a href="https://readr.tidyverse.org/reference/read_rds.html" class="external-link">write_rds</a></span><span class="op">(</span><span class="va">hold_out_set</span><span class="op">$</span><span class="va">E7420L</span><span class="op">$</span><span class="va">train</span>,
            <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="st">"train_set_new_protocol_input.rds"</span><span class="op">)</span><span class="op">)</span>

  <span class="fu"><a href="https://readr.tidyverse.org/reference/read_rds.html" class="external-link">write_rds</a></span><span class="op">(</span><span class="va">hold_out_set</span><span class="op">$</span><span class="va">SolexaPrep</span><span class="op">$</span><span class="va">train</span>,
            <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="st">"train_set_old_protocol_input.rds"</span><span class="op">)</span><span class="op">)</span>
  
    <span class="fu"><a href="https://readr.tidyverse.org/reference/read_rds.html" class="external-link">write_rds</a></span><span class="op">(</span><span class="va">full_set_90min_both_protocols</span>,
            <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="st">"full_set_both_protocol_input.rds"</span><span class="op">)</span><span class="op">)</span>

  <span class="fu"><a href="https://readr.tidyverse.org/reference/read_rds.html" class="external-link">write_rds</a></span><span class="op">(</span><span class="va">train_set_90min_both_protocols</span>,
            <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="st">"train_set_both_protocol_input.rds"</span><span class="op">)</span><span class="op">)</span>
  
<span class="op">}</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="copy-the-htcf-deseq-scripts-to-the-working-directory">Copy the HTCF DESeq scripts to the working directory<a class="anchor" aria-label="anchor" href="#copy-the-htcf-deseq-scripts-to-the-working-directory"></a>
</h2>
<p>These scripts will run DESeq in parallel on HTCF. The only items you’l need to edit is the path to the lookup file (if you are running more than one model), and to the dds_input in deseq_mpi.sh. If you do not keep deseq_de.R in the same directory as deseq_mpi.sh, then you’ll need to update the path to the deseq_de.R script, also.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span><span class="op">(</span><span class="va">WRITE_OUT</span><span class="op">)</span><span class="op">{</span>
  <span class="va">htcf_deseq_scripts</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'bash'</span>, 
                            <span class="st">'htcf_parallel_deseq.sh'</span>, 
                            package <span class="op">=</span> <span class="st">"brentlabRnaSeqTools"</span><span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'R_executable'</span>, 
                               <span class="st">'deseq_de.R'</span>, 
                                package <span class="op">=</span> <span class="st">"brentlabRnaSeqTools"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">htcf_deseq_scripts</span>, <span class="va">file.copy</span>, to <span class="op">=</span> <span class="va">DDS_OUTPUT_DIR</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Chase Mateusiak.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
